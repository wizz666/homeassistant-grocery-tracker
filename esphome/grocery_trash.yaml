# ─────────────────────────────────────────────────────────────────────────────
# Grocery Scanner – SOPOR  (Ta bort varor / logga svinn)
# ─────────────────────────────────────────────────────────────────────────────
# Samma hårdvara som grocery_kitchen.yaml.
# Enda skillnaden: action = "remove" istället för "add".
# LED blinkar RÖD (om du har en RGB-LED) eller snabbt 2× för att skilja från kök.
# ─────────────────────────────────────────────────────────────────────────────

esphome:
  name: grocery-trash
  friendly_name: "Matscanner Sopor"

esp32:
  board: esp32dev
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "GroceryTrash Fallback"
    password: "grocery123"

captive_portal:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

logger:
  level: INFO

# ── UART – GM65 Barcode Scanner ───────────────────────────────────────────────
uart:
  id: scanner_uart
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 9600
  data_bits: 8
  parity: NONE
  stop_bits: 1

# ── Streckkods-sensor ─────────────────────────────────────────────────────────
text_sensor:
  - platform: uart
    id: barcode_raw
    name: "Streckkod sopor (rådata)"
    uart_id: scanner_uart
    separator: "\n"
    icon: mdi:barcode
    filters:
      - lambda: |-
          std::string s = x;
          s.erase(std::remove(s.begin(), s.end(), '\r'), s.end());
          s.erase(std::remove(s.begin(), s.end(), ' '), s.end());
          return s.empty() ? optional<std::string>{} : s;
    on_value:
      then:
        - logger.log:
            format: "Sop-scanner: streckkod = %s"
            args: [x.c_str()]
        # Skicka event till Home Assistant (action = remove)
        - homeassistant.event:
            event: grocery_scan
            data:
              barcode: !lambda 'return x;'
              action: "remove"
              source: "trash_scanner"
        # Dubbel-blink för att signalera "borttagen"
        - light.turn_on:
            id: status_led
            flash_length: 200ms
        - delay: 300ms
        - light.turn_on:
            id: status_led
            flash_length: 200ms
        - if:
            condition:
              lambda: 'return id(buzzer_enabled);'
            then:
              # Två snabba pip = "borttagen"
              - output.turn_on: buzzer
              - delay: 60ms
              - output.turn_off: buzzer
              - delay: 100ms
              - output.turn_on: buzzer
              - delay: 60ms
              - output.turn_off: buzzer

# ── LED & Buzzer ──────────────────────────────────────────────────────────────
light:
  - platform: status_led
    id: status_led
    name: "Status LED sopor"
    pin: GPIO2

output:
  - platform: gpio
    id: buzzer
    pin: GPIO15

# ── Knappar ───────────────────────────────────────────────────────────────────
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
      inverted: true
    name: "Skanna-knapp sopor"
    on_press:
      then:
        - uart.write:
            id: scanner_uart
            data: [0x7E, 0x00, 0x08, 0x01, 0x00, 0x02, 0x01, 0xAB, 0xCD]

# ── Inställningar ─────────────────────────────────────────────────────────────
globals:
  - id: buzzer_enabled
    type: bool
    restore_value: true
    initial_value: 'true'

switch:
  - platform: template
    name: "Buzzer aktiv (sopor)"
    id: buzzer_switch
    lambda: 'return id(buzzer_enabled);'
    turn_on_action:
      - globals.set:
          id: buzzer_enabled
          value: 'true'
    turn_off_action:
      - globals.set:
          id: buzzer_enabled
          value: 'false'
